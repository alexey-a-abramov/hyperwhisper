name: Build Native Library

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept Android Licenses
      run: yes | sdkmanager --licenses || true

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;27.0.12077973"
        sdkmanager --install "cmake;3.22.1"

    - name: Generate debug keystore
      run: |
        mkdir -p ~/.android
        keytool -genkey -v -keystore ~/.android/debug.keystore \
          -storepass android -alias androiddebugkey -keypass android \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -dname "CN=Android Debug,O=Android,C=US"

    - name: Build Native Libraries
      run: |
        chmod +x gradlew
        echo "Starting Gradle build..."
        ./gradlew assembleLocalDebug --stacktrace --info || {
          echo "Build failed. Showing last 100 lines of build output:"
          echo "Checking for common issues..."
          ls -la app/src/main/cpp/
          ls -la app/src/main/cpp/whisper/ || echo "Whisper directory not found"
          exit 1
        }

    - name: List built libraries
      run: |
        echo "Listing built native libraries:"
        find app/build -name "*.so" -type f || echo "No .so files found"
        ls -R app/build/intermediates/merged_native_libs/localDebug/mergeLocalDebugNativeLibs/out/lib/ || echo "Directory not found"

    - name: Upload Native Libraries
      uses: actions/upload-artifact@v4
      with:
        name: native-libs
        path: app/build/intermediates/merged_native_libs/localDebug/mergeLocalDebugNativeLibs/out/lib/
        retention-days: 30

    - name: Commit Native Libraries
      if: success()
      run: |
        mkdir -p app/src/main/jniLibs
        cp -r app/build/intermediates/merged_native_libs/localDebug/mergeLocalDebugNativeLibs/out/lib/* app/src/main/jniLibs/
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add app/src/main/jniLibs
        git diff --staged --quiet || git commit -m "chore: Update pre-built native libraries" -m "Auto-generated by GitHub Actions"

    - name: Push changes
      if: success()
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
