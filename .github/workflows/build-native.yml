name: Build Native Library

on:
  push:
    branches: [ master ]
    paths:
      - 'app/src/main/cpp/**'
      - 'app/build.gradle.kts'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;27.0.12077973"
        sdkmanager --install "cmake;3.22.1"

    - name: Build Native Libraries
      run: |
        chmod +x gradlew
        ./gradlew assembleLocalDebug

    - name: Upload Native Libraries
      uses: actions/upload-artifact@v4
      with:
        name: native-libs
        path: app/build/intermediates/merged_native_libs/localDebug/out/lib/
        retention-days: 30

    - name: Commit Native Libraries
      if: success()
      run: |
        mkdir -p app/src/main/jniLibs
        cp -r app/build/intermediates/merged_native_libs/localDebug/out/lib/* app/src/main/jniLibs/
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add app/src/main/jniLibs
        git diff --staged --quiet || git commit -m "chore: Update pre-built native libraries

ðŸ¤– Auto-generated by GitHub Actions"

    - name: Push changes
      if: success()
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
